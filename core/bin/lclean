#!/bin/bash

#     Copyright 2002-2009 Stefano Pettini, Fabio Ricci, Massimo Rimondini
#     Computer Networks Research Group, Roma Tre University.
#
#     This file is part of Netkit.
# 
#     Netkit is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
# 
#     Netkit is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
# 
#     You should have received a copy of the GNU General Public License
#     along with Netkit.  If not, see <http://www.gnu.org/licenses/>.

# This script can be used to clean up a directory that contains a Netkit lab.
# All temporary files are removed, including .disk files.

SCRIPTNAME=$(basename "$0")

if [ -z "$NETKIT_HOME" ]; then
   echo 1>&2 "$SCRIPTNAME: The NETKIT_HOME environment variable is not properly set;"
   echo 1>&2 "please set it as described in the Netkit documentation and try again."
   exit 1
fi

# shellcheck source=./script_utils
. "$NETKIT_HOME/bin/script_utils"


# Write to the vcommands log
log_write "$0 $*"


# This function is used to print the lclean help dialog
# Usage: help 
help() {
   echo "Usage: $SCRIPTNAME [OPTION]... [MACHINE]..."
   cat << END_OF_HELP
Clean a Netkit lab directory of temporary files and machine file systems.

This command can be used to clean up a directory containing a Netkit lab. It
takes care of removing any temporary files, that is, '.ready' files, '.log'
files, the 'readyfor.test' file as well as virtual machines (COW) filesystems
('.disk' files). Therefore, any change to the virtual machines filesystems is
lost. Of course, any persistent part of the lab is preserved, including those
files that are automatically copied inside virtual machines during the boot
phase.

Available options are:

  -d DIRECTORY        Clean up the lab inside DIRECTORY. By default, the
                      cleaning process takes place in the current directory.

This command also supports the following standard options:

  -h, --help          Show this help.
  -v, --verbose       Show which files are being deleted.
      --version       Print version information and exit.

The cleaning process involves temporary files generated for any of the virtual
machines of the lab. If one or more MACHINEs are passed on the command
line, then only those files generated for the matching virtual machines are
deleted, as well as the 'readyfor.test' file. If any of the VM names are
invalid (i.e., it does not correspond to a virtual machine of the lab), it will
simply be skipped.
END_OF_HELP
}


# Output lclean's usage to stderr
# Usage: usage
usage() {
   echo 1>&2 "Usage: $SCRIPTNAME [OPTION]... [MACHINE]..."
   echo 1>&2 "Try '$SCRIPTNAME --help' for more information."
}


# Get command line options
LONG_OPTS="help,version,verbose"
SHORT_OPTS="d:hv"

if ! GETOPT_OPTS=$(getopt --name "$SCRIPTNAME" --options "$SHORT_OPTS" --longoptions "$LONG_OPTS" -- "$@"); then
   # getopt will output the errorneous command-line argument
   usage
   exit 1
fi

# (Safely) set positional parameters to those reordered by getopt
eval set -- "$GETOPT_OPTS"

while true; do
   case "$1" in
      -d)
         OPT_ARG="$2"
         shift

         if [ -n "$LAB_DIRECTORY" ]; then
            echo 1>&2 "$SCRIPTNAME: Multiple directory specifications"
            usage
            exit 1
         fi

         LAB_DIRECTORY=$(makeAbsolutePath "$OPT_ARG")
         ;;
      -h|--help)
         help
         exit 0
         ;;
      -v|--verbose)
         VERBOSE=1
         ;;
      --version)
         showVersion
         exit 0
         ;;
      --)
         shift
         break
         ;;
      *)
         echo 1>&2 "$SCRIPTNAME: Unknown error parsing command line arguments"
         usage
         exit 1
         ;;
   esac

   shift
done

# Non-option arguments are machine names
VHOSTLIST=( "$@" )

for host in "${VHOSTLIST[@]}"; do
   checkSpaces "$host"
done


# If no lab directory has been given, assume current directory
LAB_DIRECTORY=${LAB_DIRECTORY:-$PWD}

# Check that the lab directory exists
if [ ! -d "$LAB_DIRECTORY" ]; then
   echo 1>&2 "$SCRIPTNAME: $LAB_DIRECTORY: Directory does not exist"
   exit 1
fi

# shellcheck source=./lcommon
. "$NETKIT_HOME/bin/lcommon"

# Print lab information
bold_print "====================== Cleaning up lab =========================="
lab_welcome
bold_print "================================================================="

# Clean up the lab directory
lab_clean
bold_print "Cleaning completed."
bold_print "================================================================="
